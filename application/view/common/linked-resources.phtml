<?php
$pagination = $this->pagination(null, $totalCount, $page, $perPage);
$fragment = 'resources-linked';
$pagination->setFragment($fragment);

$lang = null;
$filterLocale = false;
if ($this->status()->isSiteRequest()) {
    $lang = $this->lang();
    $filterLocale = (bool) $this->siteSetting('filter_locale_values');
}
?>
<div id="linked-resources">

<div class="linked-header">
    <div id="linked-filter">
        <label>
            <?php echo $this->translate('Filter by property'); ?>
            <select id="filter-property" name="property" data-url="<?php echo $this->escapeHtml($this->url(null, [], true)); ?>" data-fragment="<?php echo $this->escapeHtml($fragment); ?>">
                <option value=""><?php echo $this->translate('All'); ?></option>
                <?php foreach ($properties as $prop): ?>
                <?php $label = $prop['property_alternate_label'] ? $this->translate($prop['property_alternate_label']) : $this->translate($prop['property_label']); ?>
                <option value="<?php echo $this->escapeHtml($prop['id_concat']); ?>"<?php echo $prop['id_concat'] === $propertyId ? ' selected' : ''; ?>><?php echo sprintf('%s (%s)', $label, $prop['term']);  ?></option>
                <?php endforeach; ?>
            </select>
        </label>
    </div>
    <?php echo ($totalCount > $perPage) ? $pagination : ''; ?>
</div>

<?php foreach ($subjectValues as $values): ?>
<table>
    <caption class="linked-resource-property"><?php echo $values[0]['property_alternate_label'] ?? $this->translate($values[0]['property_label']); ?></caption>
    <thead>
        <tr>
            <th><?php echo $this->translate('Title'); ?></th>
            <th><?php echo $this->translate('Class'); ?></th>
        </tr>
    </thead>
    <tbody>
        <?php foreach ($values as $value): ?>
        <tr class="linked-resource">
            <td><?php echo $value['value']->resource()->linkPretty('square', null, null, null, ($filterLocale ? $lang : null)); ?></td>
            <td>
                <?php if ($value['value']->resource()->resourceClass()): ?>
                <span class="resource-class"><?php echo $this->escapeHtml($this->translate($value['value']->resource()->resourceClass()->label())); ?></span>
                <?php endif; ?>
            </td>
        </tr>
        <?php endforeach; ?>
    </tbody>
</table>
<?php endforeach; ?>

<?php echo ($totalCount > $perPage) ? '<div class="linked-footer">' . $pagination . '</div>' : ''; ?>

</div>

<script>
$('#filter-property').on('change', function(e) {
    var thisSelect = $(this);
    var property = thisSelect.find(':selected').val();
    var url = thisSelect.data('url');
    var fragment = thisSelect.data('fragment');
    window.location = url + '?' + $.param({property: property}) + '#' + fragment;
});
</script>
