<?php
$translate = $this->plugin('translate');
// Prepare the item set queries
$inIds = $query['item_set_id'] ?? [];
if (!is_array($inIds)) {
    $inIds = [$inIds];
}
$inIds = array_filter($inIds);
$notInIds = $query['not_item_set_id'] ?? [];
if (!is_array($notInIds)) {
    $notInIds = [$notInIds];
}
$notInIds = array_filter($notInIds);
$itemSets = [];
foreach ($inIds as $inId) {
    $itemSets[] = ['id' => $inId, 'type' => 'in'];
}
foreach ($notInIds as $notInId) {
    $itemSets[] = ['id' => $notInId, 'type' => 'not_in'];
}
if (!$itemSets) {
    $itemSets[] = ['id' => null, 'type' => 'in'];
}

if ($this->status()->isSiteRequest()) {
    if (!$this->layout()->site->siteItemSets()) {
        return;
    }
    $filterLocale = (bool) $this->siteSetting('filter_locale_values');
    $lang = $this->lang();

    $selectOptions = [
        'disable_group_by_owner' => true,
        'query' => ['site_id' => $this->layout()->site->id()],
        'lang' => $filterLocale ? [$lang, ''] : null
    ];
} else {
    $selectOptions = [];
}
?>
<div id="item-sets-alerts" class="sr-only alerts" aria-atomic="true" aria-live="polite">
    <p><?php echo sprintf($translate('Number of rows in %s:'), $translate('Search by item set')); ?> <span class="count">1</span></p>
</div> 
<div id="item-sets" class="field removable multi-value" role="group" aria-labelledby="by-item-set-label" data-index="1">
    <div class="field-meta">
        <span id="by-item-set-label" class="label"><?php echo $translate('Search by item set'); ?></span>
        <?php echo $this->hyperlink('', '#', ['class' => 'expand', 'title' => $translate('Expand')]); ?>
        <div class="collapsible">
            <div class="field-description"><?php echo $translate('Searches for items that are assigned to any of these item sets.'); ?></div>
        </div>
        <button type="button" class="add-value o-icon-add button" aria-label="<?php echo $translate('Add new item set'); ?>" title="<?php echo $translate('Add new item set'); ?>"></button>
        <div id="item-set-condition" class="label sr-only" aria-hidden="true"><?php echo $translate('Condition'); ?></div>
        <div id="item-set-title" class="label sr-only" aria-hidden="true"><?php echo $translate('Item set'); ?></div>
        <div id="item-set-remove" class="label sr-only" aria-hidden="true"><?php echo $translate('Remove value'); ?></div>
    </div>
    <div class="inputs">
        <?php
            $index = 1;
            $rowAriaLabel = $translate(sprintf('Row %s', $index));
            $rowLabels = 'item-sets-row-' . $index . ' by-item-set-label';
        ?>
        <?php foreach ($itemSets as $itemSet): ?>
        <div class="value" id="item-sets-row-<?php echo $index; ?>" aria-label="<?php echo $rowAriaLabel; ?>" aria-labelledby="by-item-set-label">
            <div class="item-set-condition input">
                <span class="visible-label" aria-hidden="true"><?php echo $translate('Condition'); ?></span>
                <select class="item-set-select-type" aria-labelledby="item-set-condition <?php echo $rowLabels; ?>">
                    <option value="in"<?php echo 'in' === $itemSet['type'] ? ' selected' : ''; ?>><?php echo $translate('In'); ?></option>
                    <option value="not_in"<?php echo 'not_in' === $itemSet['type'] ? ' selected' : ''; ?>><?php echo $translate('Not in'); ?></option>
                </select>
            </div>
            <div class="item-set-title input">
                <span class="visible-label" aria-hidden="true"><?php echo $translate('Item set'); ?></span>
                <?php echo $this->itemSetSelect([
                    'name' => ('not_in' === $itemSet['type']) ? 'not_item_set_id[]' : 'item_set_id[]',
                    'attributes' => [
                        'value' => $itemSet['id'],
                        'class' => 'item-set-select',
                        'aria-labelledby' => 'item-set-title ' . $rowLabels,
                    ],
                    'options' => $selectOptions,
                ]); ?>
            </div>
            <button type="button" class="o-icon-delete remove-value button" aria-labelledby="item-set-remove <?php echo $rowLabels; ?>" title="<?php echo $translate('Remove value'); ?>"></button>
        </div>
        <?php 
        $index++;
        endforeach; 
        ?>
    </div>
</div>
<script>
$('#content').on('change', '.item-set-select-type', function() {
    const typeSelect = $(this);
    const itemSetSelect = typeSelect.closest('.value').find('.item-set-select');
    if ('not_in' === typeSelect.val()) {
        itemSetSelect.attr('name', 'not_item_set_id[]');
    } else {
        itemSetSelect.attr('name', 'item_set_id[]');
    }
});
</script>
