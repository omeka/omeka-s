<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
    xmlns:crmarchaeo="http://www.cidoc-crm.org/extensions/crmarchaeo/"
    xmlns:excav="https://purl.org/ah/ms/excavation#"
    xmlns:dbo="http://dbpedia.org/ontology/"
    xmlns:geo="http://www.w3.org/2003/01/geo/wgs84_pos#"
    xmlns:foaf="http://xmlns.com/foaf/0.1/"
    xmlns:dcterms="http://purl.org/dc/terms/"
    xmlns:time="http://www.w3.org/2006/time#"
    xmlns:crmsci="https://cidoc-crm.org/extensions/crmsci/"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema#">

  <xsl:output method="xml" indent="yes"/>

  <xsl:template match="/">
    <rdf:RDF>
      <!-- Main Excavation -->
      <crmarchaeo:A9_Archaeological_Excavation rdf:about="excav:Excavation_{Excavation/Acronym}">
        <dcterms:identifier><xsl:value-of select="Excavation/Acronym"/></dcterms:identifier>
        
        <!-- Location -->
        <dbo:Place rdf:resource="excav:Place_{Excavation/Location/Name}"/>
        
        <!-- Person in Charge -->
        <excav:hasPersonInCharge rdf:resource="excav:Archaeologist_{Excavation/PersonInCharge/ORCID}"/>
        
        <!-- Contexts -->
        <xsl:for-each select="Excavation/Contexts/Context">
          <excav:hasContext rdf:resource="excav:Context_{@id}"/>
        </xsl:for-each>
      </crmarchaeo:A9_Archaeological_Excavation>

      <!-- Location Details -->
      <dbo:Place rdf:about="excav:Place_{Excavation/Location/Name}">
        <dbo:district rdf:resource="excav:District_{Excavation/Location/District}"/>
        <dbo:parish rdf:resource="excav:Parish_{Excavation/Location/Parish}"/>
        <dbo:informationName><xsl:value-of select="Excavation/Location/Name"/></dbo:informationName>
        <excav:hasGPSCoordinates rdf:resource="excav:GPSCoords_{Excavation/Location/Name}"/>
      </dbo:Place>

      <!-- GPS Coordinates -->
      <geo:SpatialThing rdf:about="excav:GPSCoords_{Excavation/Location/Name}">
        <geo:lat rdf:datatype="xsd:decimal"><xsl:value-of select="Excavation/Location/GPS/Lat"/></geo:lat>
        <geo:long rdf:datatype="xsd:decimal"><xsl:value-of select="Excavation/Location/GPS/Long"/></geo:long>
      </geo:SpatialThing>

      <!-- Archaeologist -->
      <excav:Archaeologist rdf:about="excav:Archaeologist_{Excavation/PersonInCharge/ORCID}">
        <foaf:account rdf:resource="https://orcid.org/{Excavation/PersonInCharge/ORCID}"/>
        <foaf:name><xsl:value-of select="Excavation/PersonInCharge/Name"/></foaf:name>
        <xsl:for-each select="Excavation/PersonInCharge/Emails/Email">
          <foaf:mbox rdf:resource="mailto:{.}"/>
        </xsl:for-each>
      </excav:Archaeologist>

      <!-- Context Processing -->
      <xsl:apply-templates select="Excavation/Contexts/Context"/>

    </rdf:RDF>
  </xsl:template>

  <xsl:template match="Context">
    <crmarchaeo:A1_Excavation_Processing_Unit rdf:about="excav:Context_{@id}">
      <dcterms:identifier><xsl:value-of select="@id"/></dcterms:identifier>
      <dcterms:description><xsl:value-of select="Description"/></dcterms:description>
      
      <!-- Stratigraphic Units -->
      <xsl:for-each select="StratigraphicUnit">
        <excav:hasSVU rdf:resource="excav:SVU_{@id}"/>
      </xsl:for-each>
      
      <!-- Encounter Event -->
      <crmsci:S19_Encounter_Event rdf:resource="excav:Event_{@id}"/>
    </crmarchaeo:A1_Excavation_Processing_Unit>

    <!-- Stratigraphic Unit Details -->
    <xsl:apply-templates select="StratigraphicUnit"/>

    <!-- Encounter Event Details -->
    <crmsci:S19_Encounter_Event rdf:about="excav:Event_{@id}">
      <dcterms:date rdf:datatype="xsd:date"><xsl:value-of select="EncounterEvent/Date"/></dcterms:date>
      <dbo:depth rdf:datatype="xsd:decimal"><xsl:value-of select="EncounterEvent/Depth"/></dbo:depth>
      <crmsci:O19_encountered_object rdf:resource="ah:arrowhead{substring-after(EncounterEvent/FoundItem, 'AH')}"/>
      <excav:foundInSVU rdf:resource="excav:SVU_{StratigraphicUnit/@id}"/>
      <excav:foundInAContext rdf:resource="excav:Context_{@id}"/>
      <excav:foundInAExcavation rdf:resource="excav:Excavation_{../../Acronym}"/>
    </crmsci:S19_Encounter_Event>
  </xsl:template>

  <xsl:template match="StratigraphicUnit">
    <crmarchaeo:A2_Stratigraphic_Volume_Unit rdf:about="excav:SVU_{@id}">
      <dcterms:identifier><xsl:value-of select="@id"/></dcterms:identifier>
      <dcterms:description><xsl:value-of select="Description"/></dcterms:description>
      
      <!-- Timeline -->
      <excav:hasTimeLine rdf:resource="excav:Timeline_{@id}"/>
    </crmarchaeo:A2_Stratigraphic_Volume_Unit>

    <!-- Timeline Details -->
    <time:TemporalEntity rdf:about="excav:Timeline_{@id}">
      <xsl:for-each select="Timeline/LowerBound">
        <time:hasBeginning rdf:resource="excav:Instant_Lower_{@year}"/>
      </xsl:for-each>
      <xsl:for-each select="Timeline/UpperBound">
        <time:hasEnd rdf:resource="excav:Instant_Upper_{@year}"/>
      </xsl:for-each>
    </time:TemporalEntity>

    <!-- Time Instants -->
    <xsl:apply-templates select="Timeline/*"/>
  </xsl:template>

  <xsl:template match="LowerBound|UpperBound">
    <time:Instant rdf:about="excav:Instant_{local-name()}_{@year}">
      <time:inXSDYear rdf:datatype="xsd:gYear"><xsl:value-of select="@year"/></time:inXSDYear>
      <excav:bc rdf:datatype="xsd:boolean"><xsl:value-of select="@bc"/></excav:bc>
    </time:Instant>
  </xsl:template>

</xsl:stylesheet>